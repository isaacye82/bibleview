<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>留言板 - Guestbook</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', 'Microsoft YaHei', Arial, sans-serif; background-color: #f3f4f6; }
        .guestbook-container { max-width: 800px; margin: 40px auto; padding: 20px; background-color: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .message-card { border-left: 5px solid #6366f1; }
        .reply-card { border-left: 3px dotted #10b981; }
        .btn-primary { background-color: #6366f1; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #4f46e5; }
        /* Add smooth transitions for the reply form */
        .reply-form-container { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .reply-form-container.active { max-height: 500px; }
        @media (max-width: 640px) {
            .guestbook-container { margin: 10px auto; padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="guestbook-container">
        <h1 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-2">网站留言板</h1>
        
        <!-- User Info Display -->
        <div id="user-info" class="mb-4 p-3 bg-indigo-100 rounded-lg text-sm text-indigo-700">
            加载中...
        </div>

        <!-- New Message Form -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">留下您的宝贵留言</h2>
            <form id="message-form" class="space-y-4">
                <textarea id="message-content" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" rows="4" placeholder="在此输入您的留言..." required></textarea>
                <button type="submit" id="submit-button" class="btn-primary w-full py-2 px-4 rounded-lg font-semibold disabled:opacity-50">提交留言</button>
            </form>
        </div>

        <!-- Guestbook Entries List -->
        <h2 class="text-2xl font-bold mb-4 text-gray-800">所有留言</h2>
        <div id="messages-list" class="space-y-6">
            <p class="text-center text-gray-500">正在加载留言...</p>
        </div>
        <div class="text-center mt-8 text-sm text-gray-500">
            <a href="../index.html" class="hover:text-indigo-600 transition">返回主页</a>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 启用Firebase调试日志
        setLogLevel('Debug');

        // --- 全局配置变量 (由Canvas环境提供) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth, userId = null;
        let isAuthReady = false;
        
        // Firestore 留言板数据路径 (公共数据)
        const MESSAGES_COLLECTION = `artifacts/${appId}/public/data/guestbook_entries`;

        // --- 实用函数 ---
        // 格式化时间戳
        const formatTimestamp = (timestamp) => {
            if (!timestamp) return '刚刚';
            if (timestamp.toDate) { // Firestore Timestamp
                return new Date(timestamp.toDate()).toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit'
                });
            }
            // Fallback for JS Date object or string (used for replies)
            return new Date(timestamp).toLocaleString('zh-CN', {
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit'
            });
        };

        // 简易消息提示框 (代替 alert)
        function alertMessage(message, type) {
            const div = document.createElement('div');
            const color = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            div.className = `fixed top-5 right-5 ${color} text-white p-4 rounded-lg shadow-xl z-50 transition-opacity duration-300`;
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => {
                div.style.opacity = '0';
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }

        // --- FIREBASE 初始化和认证 ---
        const initializeFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 监听认证状态变化
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // 提示用户ID用于留言
                        document.getElementById('user-info').innerHTML = `
                            您已登录。您的公共用户ID是: <span class="font-mono font-semibold">${userId}</span> (用于留言和回复)<br>
                            请勿泄露您的完整ID。
                        `;
                    } else {
                        // 匿名登录失败时的后备方案
                        userId = crypto.randomUUID();
                        document.getElementById('user-info').innerHTML = `
                            匿名模式：您当前使用的临时ID是: <span class="font-mono font-semibold">${userId}</span> (此ID在下次访问时将更改)<br>
                            请勿泄露您的完整ID。
                        `;
                    }
                    isAuthReady = true;
                    // 认证完成后，开始监听留言
                    setupMessagesListener();
                });

                // 尝试使用自定义令牌或匿名方式登录
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase 初始化或认证错误:", error);
                document.getElementById('user-info').innerHTML = `<span class="text-red-600">错误: 无法连接留言板服务。请稍后重试。</span>`;
            }
        };
        
        // --- UI 渲染函数 ---
        
        function createReplyElement(reply) {
            return `
                <div class="reply-card p-3 ml-6 mt-2 bg-gray-50 rounded-lg text-sm shadow-inner">
                    <p class="font-semibold text-teal-600">${reply.username} 
                        <span class="text-xs font-normal text-gray-400">
                            (${formatTimestamp(reply.timestamp)})
                        </span>
                    </p>
                    <p class="text-gray-700 mt-1 whitespace-pre-wrap">${reply.replyText}</p>
                </div>
            `;
        }

        function createMessageCard(message) {
            const card = document.createElement('div');
            card.className = 'message-card p-4 bg-white shadow rounded-lg';
            
            // 生成回复 HTML
            const repliesHtml = (message.replies || [])
                .map(createReplyElement)
                .join('');
            
            card.innerHTML = `
                <!-- 主留言头部 -->
                <div class="flex justify-between items-start mb-2">
                    <p class="font-bold text-lg text-indigo-700">${message.username}</p>
                    <p class="text-xs text-gray-400">${formatTimestamp(message.timestamp)}</p>
                </div>
                
                <!-- 主留言内容 -->
                <p class="text-gray-800 whitespace-pre-wrap mb-4">${message.message}</p>
                
                <!-- 操作按钮和回复区 -->
                <div class="mt-4">
                    <button data-doc-id="${message.id}" class="toggle-reply-btn text-sm font-medium text-teal-600 hover:text-teal-800 transition duration-150">
                        回复 (${(message.replies || []).length})
                    </button>
                    
                    <!-- 现有回复列表 -->
                    <div class="replies-section mt-3 space-y-2">
                        ${repliesHtml}
                    </div>

                    <!-- 回复表单 (初始隐藏) -->
                    <div id="reply-form-container-${message.id}" class="reply-form-container mt-4">
                        <form class="space-y-2 p-3 bg-gray-100 rounded-lg">
                            <textarea id="reply-input-${message.id}" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-teal-500 focus:border-teal-500" rows="2" placeholder="回复此留言..." required></textarea>
                            <button type="button" data-doc-id="${message.id}" class="reply-submit-btn btn-primary py-1 px-3 rounded-md text-sm">回复</button>
                        </form>
                    </div>
                </div>
            `;
            return card;
        }

        // --- FIRESTORE 操作 ---

        // 1. 提交新留言
        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) return console.error("认证未完成，无法提交。");

            const messageContent = document.getElementById('message-content').value.trim();
            if (messageContent === "") return;

            const submitBtn = document.getElementById('submit-button');
            submitBtn.disabled = true;
            submitBtn.textContent = '提交中...';

            try {
                await addDoc(collection(db, MESSAGES_COLLECTION), {
                    userId: userId,
                    // 显示用户名使用用户ID的前8位
                    username: `User-${userId.substring(0, 8)}`, 
                    timestamp: serverTimestamp(),
                    message: messageContent,
                    replies: [] // 初始化回复数组
                });

                document.getElementById('message-content').value = ''; // 清空表单
                alertMessage("留言成功!", 'success');
            } catch (error) {
                console.error("写入留言错误:", error);
                alertMessage("留言失败，请检查网络或稍后重试。", 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '提交留言';
            }
        });

        // 2. 提交回复和切换回复表单 (事件委托)
        document.getElementById('messages-list').addEventListener('click', async (e) => {
            const replyBtn = e.target.closest('.reply-submit-btn');
            const toggleBtn = e.target.closest('.toggle-reply-btn');

            // 切换回复表单可见性
            if (toggleBtn) {
                const docId = toggleBtn.dataset.docId;
                document.getElementById(`reply-form-container-${docId}`).classList.toggle('active');
            }

            // 提交回复
            if (replyBtn) {
                e.preventDefault();
                const docId = replyBtn.dataset.docId;
                const replyTextarea = document.getElementById(`reply-input-${docId}`);
                const replyContent = replyTextarea.value.trim();
                
                if (replyContent === "") return;
                if (!isAuthReady || !userId) return console.error("认证未完成，无法回复。");

                replyBtn.disabled = true;
                replyBtn.textContent = '回复中...';

                try {
                    const messageRef = doc(db, MESSAGES_COLLECTION, docId);
                    
                    const newReply = {
                        userId: userId,
                        username: `User-${userId.substring(0, 8)}`,
                        // 注意：对于数组内的嵌套对象，serverTimestamp() 可能不支持，所以我们使用 ISO 字符串
                        timestamp: new Date().toISOString(), 
                        replyText: replyContent
                    };

                    // 使用 arrayUnion 将回复添加到 replies 数组中
                    await updateDoc(messageRef, {
                        replies: arrayUnion(newReply)
                    });

                    replyTextarea.value = ''; // 清空回复框
                    // 隐藏回复表单
                    document.getElementById(`reply-form-container-${docId}`).classList.remove('active');
                    alertMessage("回复成功!", 'success');

                } catch (error) {
                    console.error("提交回复错误:", error);
                    alertMessage("回复失败，请检查网络或稍后重试。", 'error');
                } finally {
                    replyBtn.disabled = false;
                    replyBtn.textContent = '回复';
                }
            }
        });


        // 3. 实时监听留言
        function setupMessagesListener() {
            if (!db) return; // 数据库未初始化则退出

            const q = query(collection(db, MESSAGES_COLLECTION));
            
            // onSnapshot 实时监听数据变化
            onSnapshot(q, (snapshot) => {
                const messagesList = document.getElementById('messages-list');
                messagesList.innerHTML = ''; // 清空现有留言
                
                if (snapshot.empty) {
                    messagesList.innerHTML = '<p class="text-center text-gray-500 p-8 bg-white rounded-lg">暂无留言，快来留下第一条吧！</p>';
                    return;
                }

                const messages = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    messages.push({
                        id: doc.id,
                        ...data,
                        // 将 Firestore Timestamp 转换为毫秒时间戳以便排序
                        timestamp: data.timestamp ? data.timestamp.toMillis() : Date.now() 
                    });
                });

                // 按时间戳降序排序 (最新在前)
                messages.sort((a, b) => b.timestamp - a.timestamp);

                messages.forEach(message => {
                    messagesList.appendChild(createMessageCard(message));
                });
            }, (error) => {
                console.error("监听留言错误:", error);
                messagesList.innerHTML = '<p class="text-center text-red-500 p-8 bg-white rounded-lg">加载留言失败。</p>';
            });
        }

        // --- 启动应用 ---
        initializeFirebase();
    </script>
</body>
</html>